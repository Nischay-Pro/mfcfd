!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7259) - 18 Jan 2019 09:36
!
MODULE FPI_SOLVER_MOD_DIFF
#include <petsc/finclude/petscsys.h>
    USE DATA_STRUCTURE_MOD_DIFF
    USE FLUX_RESIDUAL_MOD_DIFF
    USE STATE_UPDATE_MOD_DIFF
    USE Q_VARIABLES_MOD_DIFF
    USE OBJECTIVE_FUNCTION_MOD_DIFF
    USE POST_PROCESSING_MOD
    IMPLICIT NONE
    
    CONTAINS
    !  Differentiation of fpi_solver in reverse (adjoint) mode (with options fixinterface):
    !   gradient     of useful results: mach q_inf theta euler cfl
    !                power *clcd *cd *vector_cost_func *cl *cm vl_const
    !                *(point.x) *(point.y) *(point.nx) *(point.ny)
    !                *(point.min_dist) *(point.prim) *(point.prim_old)
    !                *(point.flux_res) *(point.q) *(point.dq) *(point.qm)
    !                *(point.temp) *(point.vorticity_sqr) *(point.delta)
    !   with respect to varying inputs: mach q_inf theta euler cfl
    !                power *clcd *cd *vector_cost_func *cl *cm vl_const
    !                *(point.x) *(point.y) *(point.nx) *(point.ny)
    !                *(point.min_dist) *(point.prim) *(point.prim_old)
    !                *(point.flux_res) *(point.q) *(point.dq) *(point.qm)
    !                *(point.temp) *(point.vorticity_sqr) *(point.delta)
    !   Plus diff mem management of: clcd:in cd:in vector_cost_func:in
    !                cl:in cm:in point.x:in point.y:in point.nx:in
    !                point.ny:in point.min_dist:in point.prim:in point.prim_old:in
    !                point.flux_res:in point.q:in point.dq:in point.qm:in
    !                point.temp:in point.vorticity_sqr:in point.delta:in
    SUBROUTINE FPI_SOLVER_B(t)
        IMPLICIT NONE
        INTEGER :: t, i, rk, j
        INTEGER :: tb
        INTRINSIC DSQRT
        INTRINSIC DLOG10
        PetscErrorCode :: ierr
        DO i=1,local_points
            point%prim_old(:, i) = point%prim(:, i)
        END DO
        CALL FUNC_DELTA()

        ! Perform 4-stage, 3-order SSPRK update
        DO rk=1,rks
            CALL PUSHREAL8ARRAY(point%q, 4*max_points)
            CALL EVAL_Q_VARIABLES()
            
            CALL PUSHREAL8ARRAY(point%qm, 2*4*max_points)
            
            CALL PUSHREAL8ARRAY(point%dq, 2*4*max_points)
            CALL EVAL_Q_DERIVATIVES()
            !Update the ghost values from the owned process
            call update_begin_dq_ghost()
            call update_begin_qm_ghost()
            call update_end_dq_ghost()
            call update_end_qm_ghost()
            DO i=1,inner_iterations
                CALL EVAL_Q_INNER_LOOP()
                CALL PUSHREAL8ARRAY(point%dq, 2*4*max_points)
                CALL EVAL_UPDATE_INNERLOOP()
                call update_begin_dq_ghost()
                call update_end_dq_ghost()
            END DO
            
            CALL PUSHREAL8ARRAY(point%flux_res, 4*max_points)
            CALL CAL_FLUX_RESIDUAL()
            
            CALL PUSHREAL8ARRAY(point%prim, 4*max_points)
            CALL STATE_UPDATE(rk)
            CALL UPDATE_BEGIN_PRIM_GHOST()
            CALL UPDATE_END_PRIM_GHOST()
        END DO
        CALL OBJECTIVE_FUNCTION_B()
        ! CALL MPI_REDUCE(sum_res_sqr, gsum_res_sqr, 1, mpi_double, mpi_sum, 0&
        ! &             , petsc_comm_world, ierr)
        ! CALL MPI_BCAST(gsum_res_sqr, 1, mpi_double, 0, petsc_comm_world, &
        ! &            ierr)
        DO rk=rks,1,-1
            CALL POPREAL8ARRAY(point%prim, 4*max_points)
            CALL STATE_UPDATE_B(rk)
            CALL UPDATE_BEGIN_PRIMB_GHOST()
            CALL UPDATE_END_PRIMB_GHOST()
            do j = local_points+1, max_points 
                pointb%prim(:, j) = 0.0d0
                pointb%prim_old(:, j) = 0.0d0
            end do
            
            CALL POPREAL8ARRAY(point%flux_res, 4*max_points)
            CALL CAL_FLUX_RESIDUAL_B()
            CALL UPDATE_BEGIN_QB_GHOST()
            CALL UPDATE_END_QB_GHOST()
            do j = local_points+1, max_points 
                pointb%q(:, j) = 0.0d0
            end do
            CALL UPDATE_BEGIN_DQB_GHOST()
            CALL UPDATE_END_DQB_GHOST()
            do j = local_points+1, max_points 
                pointb%dq(:, :, j) = 0.0d0
            end do
            DO i=inner_iterations,1,-1
                CALL POPREAL8ARRAY(point%dq, 2*4*max_points)
                CALL EVAL_UPDATE_INNERLOOP_B()
                CALL EVAL_Q_INNER_LOOP_B()
            END DO
            CALL POPREAL8ARRAY(point%dq, 2*4*max_points)
            CALL POPREAL8ARRAY(point%qm, 2*4*max_points)
            CALL EVAL_Q_DERIVATIVES_B()
            CALL UPDATE_BEGIN_QB_GHOST()
            CALL UPDATE_END_QB_GHOST()
            do j = local_points+1, max_points 
                pointb%q(:, j) = 0.0d0
            end do
            do j = local_points+1, max_points 
                pointb%dq(:, :, j) = 0.0d0
            end do
            
            CALL POPREAL8ARRAY(point%q, 4*max_points)
            CALL EVAL_Q_VARIABLES_B()
            CALL UPDATE_BEGIN_PRIMB_GHOST()
            CALL UPDATE_END_PRIMB_GHOST()
            do j = local_points+1, max_points 
                pointb%prim(:, j) = 0.0d0
            end do
        END DO
        CALL FUNC_DELTA_B()
        CALL UPDATE_BEGIN_PRIMB_GHOST()
        CALL UPDATE_END_PRIMB_GHOST()

        
        do j = local_points+1, max_points 
            pointb%prim(:, j) = 0.0d0
        end do
        DO i=local_points,1,-1
            pointb%prim(:, i) = pointb%prim(:, i) + pointb%prim_old(:, i)
            pointb%prim_old(:, i) = 0.0_8
        END DO
    END SUBROUTINE FPI_SOLVER_B
    
    SUBROUTINE FPI_SOLVER(t)
        IMPLICIT NONE
        INTEGER :: t, i, rk
        INTRINSIC DSQRT
        INTRINSIC DLOG10
        
        PetscErrorCode :: ierr
        DO i=1,local_points
            point%prim_old(:, i) = point%prim(:, i)
        END DO
        CALL FUNC_DELTA()
        ! Perform 4-stage, 3-order SSPRK update
        DO rk=1,rks
            CALL EVAL_Q_VARIABLES()
            CALL EVAL_Q_DERIVATIVES()
            !Update the ghost values from the owned process
            call update_begin_dq_ghost()
            call update_begin_qm_ghost()
            call update_end_dq_ghost()
            call update_end_qm_ghost()
            DO i=1,inner_iterations
                CALL EVAL_Q_INNER_LOOP()
                CALL EVAL_UPDATE_INNERLOOP()
                call update_begin_dq_ghost()
                call update_end_dq_ghost()
            END DO
            
            CALL CAL_FLUX_RESIDUAL()
            CALL STATE_UPDATE(rk)
            call update_begin_prim_ghost()
            call update_end_prim_ghost()
        END DO
        CALL OBJECTIVE_FUNCTION()
        CALL MPI_REDUCE(sum_res_sqr, gsum_res_sqr, 1, mpi_double, mpi_sum, 0&
        &             , petsc_comm_world, ierr)
        CALL MPI_BCAST(gsum_res_sqr, 1, mpi_double, 0, petsc_comm_world, &
        &            ierr)
        res_new = DSQRT(gsum_res_sqr)/plen
        IF (t .LE. 2 .AND. restart .EQ. 0) THEN
            res_old = res_new
            residue = 0.d0
        ELSE
            residue = DLOG10(res_new/res_old)
        END IF
    END SUBROUTINE FPI_SOLVER
    
END MODULE FPI_SOLVER_MOD_DIFF
