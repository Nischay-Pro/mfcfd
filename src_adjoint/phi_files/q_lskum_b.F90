!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7259) - 18 Jan 2019 09:36
!
MODULE Q_LSKUM_MOD_DIFF
!	First written on 14.10.2016
!	updated on Dec 26, 2016
!	updated on Dec 29, 2016
  USE DATA_STRUCTURE_MOD_DIFF
  USE POINT_NORMALS_MOD_DIFF
  USE GENERATE_CONNECTIVITY_MOD_DIFF
  USE FPI_SOLVER_MOD_DIFF
  IMPLICIT NONE

CONTAINS
!  Differentiation of q_lskum in reverse (adjoint) mode (with options fixinterface):
!   gradient     of useful results: cost_func
!   with respect to varying inputs: point.phi1 point.phi2
!   RW status of diff variables: cost_func:in-killed point.delta:(loc)
!                point.prim:(loc) point.prim_old:(loc) point.q:(loc)
!                point.flux_res:(loc) point.dq:(loc) point.ddq:(loc)
!                point.temp:(loc) point.phi1:out point.phi2:out
SUBROUTINE Q_LSKUM_B()
    IMPLICIT NONE
    INTEGER :: i
    OPEN(unit=301, file='residue', form='FORMATTED', status='REPLACE', &
&  action='WRITE') 
    cost_funcb = 1.0d0
    CALL COMPUTE_NORMALS()
    CALL GENERATE_CONNECTIVITY()
    WRITE(*, *) '%%%%-Normals and connectivity generated-%%%'
    WRITE(*, *) 
    DO i=1,max_points
      point%phi1(:, i) = 1.0d0
      point%phi2(:, i) = 1.0d0
    END DO
! point%phi1(80,1) = point%phi1(80,1) + 1e-3
    WRITE(*, *) '%%%%%%%%%%%%%-Iterations begin-%%%%%%%%%%%%'
    WRITE(*, *) 
    IF (restart .EQ. 0) itr = 0
    DO it=itr+1,itr+max_iters
      CALL PUSHREAL8ARRAY(point%temp, 3*4*max_points)
      CALL PUSHREAL8ARRAY(point%ddq, 3*4*max_points)
      CALL PUSHREAL8ARRAY(point%dq, 2*4*max_points)
      CALL PUSHREAL8ARRAY(point%qm, 2*4*max_points)
      CALL PUSHREAL8ARRAY(point%flux_res, 4*max_points)
      CALL PUSHREAL8ARRAY(point%q, 4*max_points)
      CALL PUSHREAL8ARRAY(point%prim_old, 4*max_points)
      CALL PUSHREAL8ARRAY(point%prim, 4*max_points)
      CALL PUSHREAL8ARRAY(point%delta, max_points)
      CALL FPI_SOLVER(it)
      WRITE(*, '(a12,i8,a15,e30.20)') 'iterations:', it, 'residue:', &
&     residue
      WRITE(301, *) it, residue
    END DO
! if(residue.ne.residue)exit
    CLOSE(unit=301) 
    pointb%delta = 0.0_8
    pointb%prim = 0.0_8
    pointb%prim_old = 0.0_8
    pointb%q = 0.0_8
    pointb%flux_res = 0.0_8
    pointb%dq = 0.0_8
    pointb%ddq = 0.0_8
    pointb%temp = 0.0_8
    pointb%phi1 = 0.0_8
    pointb%phi2 = 0.0_8
    ! if(rank == 0) then
    write(*,*)
    write(*,*)'%%%%%%%%-Adjoint computations begin-%%%%%%%'
    write(*,*)
    ! end if
    DO it=itr+max_iters,itr+1,-1
        CALL POPREAL8ARRAY(point%delta, max_points)
        CALL POPREAL8ARRAY(point%prim, 4*max_points)
        CALL POPREAL8ARRAY(point%prim_old, 4*max_points)
        CALL POPREAL8ARRAY(point%q, 4*max_points)
        CALL POPREAL8ARRAY(point%flux_res, 4*max_points)
        CALL POPREAL8ARRAY(point%qm, 2*4*max_points)
        CALL POPREAL8ARRAY(point%dq, 2*4*max_points)
        CALL POPREAL8ARRAY(point%ddq, 3*4*max_points)
        CALL POPREAL8ARRAY(point%temp, 3*4*max_points)
        CALL FPI_SOLVER_B(it)
        cost_funcb = 0.0_8
    END DO
    OPEN(unit=301, file='jderivatives_b.dat', form='FORMATTED', status='REPLACE', action='WRITE')
        DO i=1,max_points
            WRITE(301,*) pointb%phi1(:,i)
        END DO
    CLOSE(unit=301)
    DO i=max_points,1,-1
      pointb%phi2(:, i) = 0.0_8
      pointb%phi1(:, i) = 0.0_8
    END DO
  END SUBROUTINE Q_LSKUM_B

  SUBROUTINE Q_LSKUM()
    IMPLICIT NONE
    INTEGER :: i
    OPEN(unit=301, file='residue', form='FORMATTED', status='REPLACE', &
&  action='WRITE')
    CALL COMPUTE_NORMALS()
    CALL GENERATE_CONNECTIVITY()
    WRITE(*, *) '%%%%-Normals and connectivity generated-%%%'
    WRITE(*, *)
    DO i=1,max_points
      point%phi1(:, i) = 1.0d0
      point%phi2(:, i) = 1.0d0
    END DO
! point%phi1(80,1) = point%phi1(80,1) + 1e-3
    WRITE(*, *) '%%%%%%%%%%%%%-Iterations begin-%%%%%%%%%%%%'
    WRITE(*, *)
    IF (restart .EQ. 0) itr = 0
    DO it=itr+1,itr+max_iters
      CALL FPI_SOLVER(it)
      WRITE(*, '(a12,i8,a15,e30.20)') 'iterations:', it, 'residue:', &
&     residue
      WRITE(301, *) it, residue
      IF (residue .NE. residue) GOTO 100
    END DO
 100 CLOSE(unit=301)
  END SUBROUTINE Q_LSKUM

END MODULE Q_LSKUM_MOD_DIFF