!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7079) -  5 Oct 2018 09:56
!
MODULE FPI_SOLVER_MOD_DIFF
#include <petsc/finclude/petscsys.h>

  USE DATA_STRUCTURE_MOD_DIFF
  USE PETSC_DATA_STRUCTURE_MOD
  USE FLUX_RESIDUAL_MOD_DIFF
  USE STATE_UPDATE_MOD_DIFF
  USE Q_VARIABLES_MOD_DIFF
  USE OBJECTIVE_FUNCTION_MOD_DIFF
  IMPLICIT NONE

CONTAINS
!  Differentiation of fpi_solver in reverse (adjoint) mode (with options fixinterface):
!   gradient     of useful results: total_enstrophy cd cl cm total_entropy
!                point.x point.y point.nx point.ny point.prim point.prim_old
!                point.flux_res point.q point.dq point.qm point.vorticity_sqr
!                point.delta
!   with respect to varying inputs: point.x point.y point.nx point.ny
!                point.prim point.prim_old point.flux_res point.q
!                point.dq point.qm point.vorticity_sqr point.delta
  SUBROUTINE FPI_SOLVER_B(t)
    IMPLICIT NONE
    INTEGER :: t, i, rk, j
    real*8 :: lresnorm
    PetscErrorCode :: ierr
    
    DO i=1,local_points
      point%prim_old(:, i) = point%prim(:, i)
    END DO
    
    DO i=1,local_points
      pointb%x_res(1, i) = pointb%x(i)
      pointb%x_res(2, i) = pointb%y(i)
    END DO
    
    CALL FUNC_DELTA()
    
    ! Perform 4-stage, 3-order SSPRK update
    DO rk=1,4
      CALL PUSHREAL8ARRAY(point%q, 4*max_points)
      CALL EVAL_Q_VARIABLES()
      CALL PUSHREAL8ARRAY(point%qm, 2*4*max_points)
      CALL PUSHREAL8ARRAY(point%dq, 2*4*max_points)
      CALL EVAL_Q_DERIVATIVES()
      call update_begin_dq_ghost()
      call update_begin_qm_ghost()
      call update_end_dq_ghost()
      call update_end_qm_ghost()
      CALL PUSHREAL8ARRAY(point%flux_res, 4*max_points)
      CALL CAL_FLUX_RESIDUAL()
      CALL PUSHREAL8ARRAY(point%prim, 4*max_points)
      CALL STATE_UPDATE(rk)
      call update_begin_prim_ghost()
      call update_end_prim_ghost()
    END DO
    
    ! Adjoint begins
    CALL OBJECTIVE_FUNCTION_B()
  
    DO rk=4,1,-1
      CALL POPREAL8ARRAY(point%prim, 4*max_points)
      CALL STATE_UPDATE_B(rk)
      CALL POPREAL8ARRAY(point%flux_res, 4*max_points)
      CALL CAL_FLUX_RESIDUAL_B()
      CALL POPREAL8ARRAY(point%dq, 2*4*max_points)
      CALL POPREAL8ARRAY(point%qm, 2*4*max_points)
      call update_begin_dqb_ghost()
      call update_begin_qmb_ghost()
      call update_end_dqb_ghost()
      call update_end_qmb_ghost()
      CALL EVAL_Q_DERIVATIVES_B()
      do j = local_points+1, max_points 
        pointb%dq(:, :, j) = 0.0d0
        pointb%qm(:, :, j) = 0.0d0
      end do
      CALL POPREAL8ARRAY(point%q, 4*max_points)
      call update_begin_qb_ghost()
      call update_end_qb_ghost()
      CALL EVAL_Q_VARIABLES_B()
      do j = local_points+1, max_points 
        pointb%q(:, j) = 0.0d0
      end do
    END DO
    
    do j = local_points+1, max_points 
      pointb%prim(:, j) = 0.0d0
    end do
   
    CALL FUNC_DELTA_B()
    call update_begin_primb_ghost()
    call update_end_primb_ghost()
    
    DO i=local_points,1,-1
      pointb%prim(:, i) = pointb%prim(:, i) + pointb%prim_old(:, i)
      pointb%prim_old(:, i) = 0.0_8
    END DO

    lresnorm = 0.0d0
    do i = 1, local_points
        lresnorm = lresnorm + (pointb%x(i) - pointb%x_res(1,i) + &
                & pointb%y(i) - pointb%x_res(2,i))**2
    end do
    call MPI_Reduce(lresnorm, adj_res, 1, MPI_DOUBLE, MPI_SUM, &
                   0, PETSC_COMM_WORLD, ierr); CHKERRQ(ierr)
    call MPI_Bcast(adj_res, 1, MPI_DOUBLE, 0, PETSC_COMM_WORLD, &
                  ierr)
    adj_res = dsqrt(adj_res)/plen
    if(t == max_iters+itr) then
        adj_res_old = adj_res
    else
        adj_res = dlog10(adj_res/adj_res_old)
    end if

  END SUBROUTINE FPI_SOLVER_B

  SUBROUTINE FPI_SOLVER(t)
    IMPLICIT NONE
    INTEGER :: t, i, rk
    PetscErrorCode :: ierr
    DO i=1,local_points
      point%prim_old(:, i) = point%prim(:, i)
    END DO
! Perform 4-stage, 3-order SSPRK update
      
    CALL FUNC_DELTA()
    
    DO rk=1,4
    
      CALL EVAL_Q_VARIABLES()
      CALL EVAL_Q_DERIVATIVES()

      call update_begin_dq_ghost()
      call update_begin_qm_ghost()
      call update_end_dq_ghost()
      call update_end_qm_ghost()
      
      CALL CAL_FLUX_RESIDUAL()
      CALL STATE_UPDATE(rk)

      call update_begin_prim_ghost()
      call update_end_prim_ghost()
    END DO
    
    
    CALL OBJECTIVE_FUNCTION()
    
    call MPI_Reduce(sum_res_sqr,gsum_res_sqr, 1, MPI_DOUBLE, MPI_SUM, &
       0, PETSC_COMM_WORLD, ierr)

    call MPI_Bcast(gsum_res_sqr, 1, MPI_DOUBLE, 0, PETSC_COMM_WORLD, &
                  ierr)

    res_new = DSQRT(gsum_res_sqr)/plen
    IF (t .LE. 2 .and. restart == 0) THEN
      res_old = res_new
      residue = 0.d0
    ELSE
      residue = DLOG10(res_new/res_old)
    END IF
    
  END SUBROUTINE FPI_SOLVER

END MODULE FPI_SOLVER_MOD_DIFF

