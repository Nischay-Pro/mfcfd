!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.16 (master) -  9 Oct 2020 17:47
!
MODULE DATA_STRUCTURE_MOD_DIFF
  USE PARAMETER_MOD
  IMPLICIT NONE
  INTEGER :: max_points, local_points, ghost_points
  INTEGER :: wall_points, interior_points, outer_points, shape_points
!       ghost global indices
  INTEGER, DIMENSION(:), ALLOCATABLE :: pghost
! stores location of point
! stores shape point belongs to 
! real*8, dimension(:,:,:), allocatable :: ddq
! Implicit data
  TYPE POINTS
      INTEGER, DIMENSION(:), ALLOCATABLE :: original_id
      REAL*8, DIMENSION(:), ALLOCATABLE :: x, y
      INTEGER, DIMENSION(:), ALLOCATABLE :: left, right
      INTEGER, DIMENSION(:), ALLOCATABLE :: flag_1
      INTEGER, DIMENSION(:), ALLOCATABLE :: flag_2
      INTEGER, DIMENSION(:), ALLOCATABLE :: qtdepth
      REAL*8, DIMENSION(:), ALLOCATABLE :: nx, ny
      INTEGER, DIMENSION(:), ALLOCATABLE :: nbhs
      INTEGER, DIMENSION(:, :), ALLOCATABLE :: conn
      REAL*8, DIMENSION(:), ALLOCATABLE :: min_dist
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: prim
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: prim_old
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: flux_res
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: q
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: u
      REAL*8, DIMENSION(:, :, :), ALLOCATABLE :: dq
      REAL*8, DIMENSION(:, :, :), ALLOCATABLE :: qm
      REAL*8, DIMENSION(:, :, :), ALLOCATABLE :: temp
      REAL*8, DIMENSION(:), ALLOCATABLE :: entropy, vorticity, &
&     vorticity_sqr
      INTEGER, DIMENSION(:), ALLOCATABLE :: xpos_nbhs, xneg_nbhs, &
&     ypos_nbhs, yneg_nbhs
      INTEGER, DIMENSION(:, :), ALLOCATABLE :: xpos_conn, xneg_conn
      INTEGER, DIMENSION(:, :), ALLOCATABLE :: ypos_conn, yneg_conn
      REAL*8, DIMENSION(:), ALLOCATABLE :: delta
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: u_old
  END TYPE POINTS
  TYPE POINTS_DIFF
      REAL*8, DIMENSION(:), ALLOCATABLE :: x
      REAL*8, DIMENSION(:), ALLOCATABLE :: y
      REAL*8, DIMENSION(:), ALLOCATABLE :: nx
      REAL*8, DIMENSION(:), ALLOCATABLE :: ny
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: prim
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: prim_old
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: flux_res
      REAL*8, DIMENSION(:, :), ALLOCATABLE :: q
      REAL*8, DIMENSION(:, :, :), ALLOCATABLE :: dq
      REAL*8, DIMENSION(:, :, :), ALLOCATABLE :: qm
      REAL*8, DIMENSION(:, :, :), ALLOCATABLE :: temp
      REAL*8, DIMENSION(:), ALLOCATABLE :: delta
  END TYPE POINTS_DIFF
  TYPE(POINTS) :: point
  TYPE(POINTS_DIFF) :: pointd
  SAVE 
  INTEGER, DIMENSION(:), ALLOCATABLE :: wall_points_index
  INTEGER, DIMENSION(:), ALLOCATABLE :: outer_points_index
  INTEGER, DIMENSION(:), ALLOCATABLE :: interior_points_index
  INTEGER, DIMENSION(:), ALLOCATABLE :: shape_points_index
!iterations
  INTEGER :: it, itr
!Flag for time stepping
  INTEGER :: rks
  REAL*8 :: euler
  REAL*8 :: total_loss_stagpressure
  REAL*8 :: res_old, res_new, residue, max_res
  REAL*8 :: gsum_res_sqr, sum_res_sqr
  INTEGER :: max_res_point
  REAL*8, DIMENSION(:), ALLOCATABLE :: cl, cd, cm, cfv, clcd, &
& vector_cost_func
  REAL*8, DIMENSION(:), ALLOCATABLE :: cld, vector_cost_funcd
  REAL*8 :: total_entropy, total_enstrophy
  INTEGER :: plen
  INTEGER :: format
!The parameter CFL is the CFL number for stability ..
  REAL*8 :: cfl
  INTEGER :: max_iters
!Unsteady variables
  REAL*8 :: t, tfinal, dtg
  INTEGER :: timestep
!Run option: petsc or normal
  INTEGER :: runop
!
!       The parameter power is used to specify the weights 
!       in the LS formula for the derivatives ..
!       power = 0.0d0, -2.0d0, -4.0d0, -6.0d0 ..
!       For example, power = -2.0 implies that
!       power = -2.0 => weights = 1/d^2
!       power = -4.0 => weights = 1/d^4
!
  REAL*8 :: power
!
!       limiter_flag = 1 => venkatakrishnan limiter
!       limiter_flag = 2 => min-max limiter     
!
  INTEGER :: limiter_flag
! Venkatakrishnan limiter constant ..
  REAL*8 :: vl_const
  INTEGER :: restart
!       Interior points normal flag ..
!       If flag is zero => nx = 0.0 and ny = 1.0
!
  INTEGER :: interior_points_normal_flag
!       Restart solution parameter
  INTEGER :: solution_restart
!       solution save parameter
  INTEGER :: nsave
!       First order flag
  REAL*8 :: fo_flag
!       Objective function
  REAL*8 :: cl_flag, cd_flag, cm_flag, cl_cd_flag, ent_flag, ens_flag
  INTEGER :: obj_flag
  INTEGER :: inner_iterations
!       No of shapes
  INTEGER :: shapes

CONTAINS
  SUBROUTINE ALLOCATE_SOLN()
    IMPLICIT NONE
    ALLOCATE(point%prim(4, max_points))
    ALLOCATE(point%prim_old(4, max_points))
    ALLOCATE(point%flux_res(4, max_points))
    ALLOCATE(point%u_old(4, max_points))
    ALLOCATE(point%q(4, max_points))
    ALLOCATE(point%u(4, max_points))
    ALLOCATE(point%dq(2, 4, max_points))
    ALLOCATE(point%qm(2, 4, max_points))
! allocate(point%ddq(3,4,max_points))
    ALLOCATE(point%temp(3, 4, max_points))
    ALLOCATE(point%entropy(max_points))
    ALLOCATE(point%vorticity(max_points))
    ALLOCATE(point%vorticity_sqr(max_points))
    ALLOCATE(point%xpos_nbhs(max_points))
    ALLOCATE(point%xneg_nbhs(max_points))
    ALLOCATE(point%ypos_nbhs(max_points))
    ALLOCATE(point%yneg_nbhs(max_points))
    ALLOCATE(point%xpos_conn(max_points, 20))
    ALLOCATE(point%xneg_conn(max_points, 20))
    ALLOCATE(point%ypos_conn(max_points, 20))
    ALLOCATE(point%yneg_conn(max_points, 20))
    ALLOCATE(point%delta(max_points))
    ALLOCATE(cl(shapes))
    ALLOCATE(cd(shapes))
    ALLOCATE(cm(shapes))
    ALLOCATE(cfv(shapes))
    ALLOCATE(clcd(shapes))
    ALLOCATE(vector_cost_func(shapes))
END SUBROUTINE ALLOCATE_SOLN

SUBROUTINE ALLOCATE_SOLN_D()
  IMPLICIT NONE
  ALLOCATE(pointd%x(max_points))
  ALLOCATE(pointd%y(max_points))
  ALLOCATE(pointd%nx(max_points))
  ALLOCATE(pointd%ny(max_points))
  ALLOCATE(pointd%prim(4,max_points))
  ALLOCATE(pointd%prim_old(4,max_points))
  ALLOCATE(pointd%flux_res(4,max_points))
  ALLOCATE(pointd%q(4,max_points))
  ALLOCATE(pointd%dq(2,4,max_points))
  ALLOCATE(pointd%temp(3, 4, max_points))
  ALLOCATE(pointd%qm(2,4,max_points))
  ALLOCATE(pointd%delta(max_points))
  ALLOCATE(Cld(shapes))
END SUBROUTINE

SUBROUTINE DEALLOCATE_SOLN()
    IMPLICIT NONE
    DEALLOCATE(point%prim)
    DEALLOCATE(point%prim_old)
    DEALLOCATE(point%flux_res)
    DEALLOCATE(point%u_old)
    DEALLOCATE(point%q)
    DEALLOCATE(point%u)
    DEALLOCATE(point%dq)
    DEALLOCATE(point%qm)
    DEALLOCATE(point%temp)
    DEALLOCATE(point%vorticity)
    DEALLOCATE(point%vorticity_sqr)
    DEALLOCATE(point%entropy)
    DEALLOCATE(point%xpos_nbhs)
    DEALLOCATE(point%xneg_nbhs)
    DEALLOCATE(point%ypos_nbhs)
    DEALLOCATE(point%yneg_nbhs)
    DEALLOCATE(point%xpos_conn)
    DEALLOCATE(point%xneg_conn)
    DEALLOCATE(point%ypos_conn)
    DEALLOCATE(point%yneg_conn)
    DEALLOCATE(point%delta)
    DEALLOCATE(cl)
    DEALLOCATE(cd)
    DEALLOCATE(cm)
    DEALLOCATE(cfv)
    DEALLOCATE(clcd)
    DEALLOCATE(vector_cost_func)
END SUBROUTINE DEALLOCATE_SOLN

SUBROUTINE DEALLOCATE_SOLN_D()
  IMPLICIT NONE
  DEALLOCATE(pointd%x)
  DEALLOCATE(pointd%y)
  DEALLOCATE(pointd%nx)
  DEALLOCATE(pointd%ny)
  DEALLOCATE(pointd%prim)
  DEALLOCATE(pointd%prim_old)
  DEALLOCATE(pointd%flux_res)
  DEALLOCATE(pointd%q)
  DEALLOCATE(pointd%dq)
  DEALLOCATE(pointd%qm)
  DEALLOCATE(pointd%temp)
  DEALLOCATE(pointd%delta)
  DEALLOCATE(Cld)
END SUBROUTINE

END MODULE DATA_STRUCTURE_MOD_DIFF
