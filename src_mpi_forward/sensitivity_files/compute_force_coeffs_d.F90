!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7259) - 18 Jan 2019 09:36
!
MODULE COMPUTE_FORCE_COEFFS_MOD_DIFF
#include <petsc/finclude/petscsys.h>
  USE DATA_STRUCTURE_MOD_DIFF
  USE PETSC_DATA_STRUCTURE_MOD
  IMPLICIT NONE

CONTAINS
!  Differentiation of compute_cl_cd_cm in forward (tangent) mode (with options fixinterface):
!   variations   of useful results: *clcd *cd *cl *cm
!   with respect to varying inputs: *clcd *cd *cl *cm *(point.x)
!                *(point.y) *(point.nx) *(point.ny) *(point.prim)
!   Plus diff mem management of: clcd:in cd:in cl:in cm:in point.x:in
!                point.y:in point.nx:in point.ny:in point.prim:in
  SUBROUTINE COMPUTE_CL_CD_CM_D()
    IMPLICIT NONE
    INTEGER :: i, j, k
    INTEGER :: l, m, r
    REAL*8 :: cp, temp
    REAL*8 :: cpd
    REAL*8 :: lx, ly, mx, my, rx, ry
    REAL*8 :: lxd, lyd, mxd, myd, rxd, ryd
    REAL*8 :: ds1, ds2, ds
    REAL*8 :: ds1d, ds2d, dsd
    REAL*8, DIMENSION(shapes) :: h, v, pitch_mom
    REAL*8, DIMENSION(shapes) :: hd, vd, pitch_momd
    REAL*8, DIMENSION(shapes) :: lcl, lcd, lcm, lcl1, lcd1
    REAL*8, DIMENSION(shapes) :: lcld, lcdd, lcmd
    REAL*8 :: nx, ny
    REAL*8 :: nxd, nyd
    CHARACTER(len=64) :: cp_file
    CHARACTER(len=10) :: itos

    INTRINSIC DSQRT
    INTRINSIC DCOS
    INTRINSIC DSIN

    PetscErrorCode :: ierr
    cp_file = 'cp/'//'cp-file'
    IF (proc .GT. 1) cp_file = 'cp/'//'cp-file'//TRIM(itos(4, rank))
    OPEN(unit=201, file=trim(cp_file), form='FORMATTED', status=&
&  'REPLACE', action='WRITE') 
    temp = 0.5d0*rho_inf*mach*mach
    h = 0.d0
    v = 0.d0
    pitch_mom = 0.0d0
    hd = 0.0_8
    vd = 0.0_8
    pitch_momd = 0.0_8
    DO j=1,shape_points
      m = shape_points_index(j)
      r = point%right(m)
      l = point%left(m)
      lxd = pointd%x(l)
      lx = point%x(l)
      lyd = pointd%y(l)
      ly = point%y(l)
      mxd = pointd%x(m)
      mx = point%x(m)
      myd = pointd%y(m)
      my = point%y(m)
      rxd = pointd%x(r)
      rx = point%x(r)
      ryd = pointd%y(r)
      ry = point%y(r)
      ds1d = 2*(mx-lx)*(mxd-lxd) + 2*(my-ly)*(myd-lyd)
      ds1 = (mx-lx)**2 + (my-ly)**2
      IF (ds1 .EQ. 0.0) THEN
        ds1d = 0.0_8
      ELSE
        ds1d = ds1d/(2.D0*DSQRT(ds1))
      END IF
      ds1 = DSQRT(ds1)
      ds2d = 2*(rx-mx)*(rxd-mxd) + 2*(ry-my)*(ryd-myd)
      ds2 = (rx-mx)**2 + (ry-my)**2
      IF (ds2 .EQ. 0.0) THEN
        ds2d = 0.0_8
      ELSE
        ds2d = ds2d/(2.D0*DSQRT(ds2))
      END IF
      ds2 = DSQRT(ds2)
      dsd = 0.5d0*(ds1d+ds2d)
      ds = 0.5d0*(ds1+ds2)
      nxd = pointd%nx(m)
      nx = point%nx(m)
      nyd = pointd%ny(m)
      ny = point%ny(m)
      cpd = pointd%prim(4, m)
      cp = point%prim(4, m) - pr_inf
      cpd = -(cpd/temp)
      cp = -(cp/temp)
      WRITE(201, *) point%flag_2(m), point%x(m), cp
      hd(point%flag_2(m)) = hd(point%flag_2(m)) + (cpd*nx+cp*nxd)*ds + &
&       cp*nx*dsd
      h(point%flag_2(m)) = h(point%flag_2(m)) + cp*nx*ds
      vd(point%flag_2(m)) = vd(point%flag_2(m)) + (cpd*ny+cp*nyd)*ds + &
&       cp*ny*dsd
      v(point%flag_2(m)) = v(point%flag_2(m)) + cp*ny*ds
      pitch_momd(point%flag_2(m)) = pitch_momd(point%flag_2(m)) + (cpd*&
&       nx+cp*nxd)*ds*my - cp*ny*(dsd*(mx-0.25d0)+ds*mxd) - (cpd*ny+cp*&
&       nyd)*ds*(mx-0.25d0) + cp*nx*(dsd*my+ds*myd)
      pitch_mom(point%flag_2(m)) = pitch_mom(point%flag_2(m)) + (-(cp*ny&
&       *ds*(mx-0.25d0))+cp*nx*ds*my)
    END DO
    lcld = DCOS(theta)*vd - DSIN(theta)*hd
    lcl = v*DCOS(theta) - h*DSIN(theta)
    lcdd = DCOS(theta)*hd + DSIN(theta)*vd
    lcd = h*DCOS(theta) + v*DSIN(theta)
    lcmd = pitch_momd
    lcm = pitch_mom
    
    call MPI_Allreduce(lCl, Cl , shapes, MPI_DOUBLE, MPI_SUM, &
    & PETSC_COMM_WORLD, ierr)
    call MPI_Allreduce(lCd, Cd , shapes, MPI_DOUBLE, MPI_SUM, &
    & PETSC_COMM_WORLD, ierr)
    call MPI_Allreduce(lCm, Cm , shapes, MPI_DOUBLE, MPI_SUM, &
    & PETSC_COMM_WORLD, ierr)

    call MPI_Allreduce(lCld, Cld , shapes, MPI_DOUBLE, MPI_SUM, &
    & PETSC_COMM_WORLD, ierr)
    call MPI_Allreduce(lCdd, Cdd , shapes, MPI_DOUBLE, MPI_SUM, &
    & PETSC_COMM_WORLD, ierr)
    call MPI_Allreduce(lCmd, Cmd , shapes, MPI_DOUBLE, MPI_SUM, &
    & PETSC_COMM_WORLD, ierr)

    clcdd = (cld*cd-cl*cdd)/cd**2
    clcd = cl/cd
! if(rank == 0) then
!     do j = 1, shapes
!         write(*,'(i4,3e30.20)') j, gCl, gCd, gCm
!     end do
! end if
    CLOSE(unit=201) 
  END SUBROUTINE COMPUTE_CL_CD_CM_D

  SUBROUTINE COMPUTE_CL_CD_CM()
    IMPLICIT NONE
    INTEGER :: i, j, k
    INTEGER :: l, m, r
    REAL*8 :: cp, temp
    REAL*8 :: lx, ly, mx, my, rx, ry
    REAL*8 :: ds1, ds2, ds
    REAL*8, DIMENSION(shapes) :: h, v, pitch_mom
    REAL*8, DIMENSION(shapes) :: lcl, lcd, lcm, lcl1, lcd1
    REAL*8 :: nx, ny
    CHARACTER(len=64) :: cp_file
    CHARACTER(len=10) :: itos

    INTRINSIC DSQRT
    INTRINSIC DCOS
    INTRINSIC DSIN

    PetscErrorCode :: ierr
    cp_file = 'cp/'//'cp-file'
    IF (proc .GT. 1) cp_file = 'cp/'//'cp-file'//TRIM(itos(4, rank))
    OPEN(unit=201, file=trim(cp_file), form='FORMATTED', status=&
&  'REPLACE', action='WRITE') 
    temp = 0.5d0*rho_inf*mach*mach
    h = 0.d0
    v = 0.d0
    pitch_mom = 0.0d0
    DO j=1,shape_points
      m = shape_points_index(j)
      r = point%right(m)
      l = point%left(m)
      lx = point%x(l)
      ly = point%y(l)
      mx = point%x(m)
      my = point%y(m)
      rx = point%x(r)
      ry = point%y(r)
      ds1 = (mx-lx)**2 + (my-ly)**2
      ds1 = DSQRT(ds1)
      ds2 = (rx-mx)**2 + (ry-my)**2
      ds2 = DSQRT(ds2)
      ds = 0.5d0*(ds1+ds2)
      nx = point%nx(m)
      ny = point%ny(m)
      cp = point%prim(4, m) - pr_inf
      cp = -(cp/temp)
      WRITE(201, *) point%flag_2(m), point%x(m), cp
      h(point%flag_2(m)) = h(point%flag_2(m)) + cp*nx*ds
      v(point%flag_2(m)) = v(point%flag_2(m)) + cp*ny*ds
      pitch_mom(point%flag_2(m)) = pitch_mom(point%flag_2(m)) + (-(cp*ny&
&       *ds*(mx-0.25d0))+cp*nx*ds*my)
    END DO
    lcl = v*DCOS(theta) - h*DSIN(theta)
    lcd = h*DCOS(theta) + v*DSIN(theta)
    lcm = pitch_mom
! call MPI_Allreduce(lCl, lCl1 , shapes, MPI_DOUBLE, MPI_SUM, &
! & PETSC_COMM_WORLD, ierr)
! call MPI_Allreduce(lCd, lCd1 , shapes, MPI_DOUBLE, MPI_SUM, &
! & PETSC_COMM_WORLD, ierr)
! call MPI_Allreduce(lCm, Cm , shapes, MPI_DOUBLE, MPI_SUM, &
! & PETSC_COMM_WORLD, ierr)
    cl = lcl
    cd = lcd
    cm = lcm
    clcd = cl/cd
! if(rank == 0) then
!     do j = 1, shapes
!         write(*,'(i4,3e30.20)') j, gCl, gCd, gCm
!     end do
! end if
    CLOSE(unit=201) 
  END SUBROUTINE COMPUTE_CL_CD_CM

END MODULE COMPUTE_FORCE_COEFFS_MOD_DIFF
