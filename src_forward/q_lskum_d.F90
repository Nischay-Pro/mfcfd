!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7079) -  5 Oct 2018 09:56
!
MODULE Q_LSKUM_MOD_DIFF
  USE DATA_STRUCTURE_MOD_DIFF
  USE PETSC_DATA_STRUCTURE_MOD
  USE POINT_NORMALS_MOD_DIFF
  USE GENERATE_CONNECTIVITY_MOD_DIFF
  USE FPI_SOLVER_MOD_DIFF
  IMPLICIT NONE

CONTAINS
!  Differentiation of q_lskum in forward (tangent) mode (with options fixinterface):
!   variations   of useful results: total_enstrophy cd cl cm total_entropy
!   with respect to varying inputs: point.x point.y
!   RW status of diff variables: total_enstrophy:out cd:out cl:out
!                cm:out total_entropy:out point.x:in point.y:in
!                point.nx:(loc) point.ny:(loc) point.prim:(loc)
!                point.prim_old:(loc) point.flux_res:(loc) point.q:(loc)
!                point.dq:(loc) point.qm:(loc) point.vorticity_sqr:(loc)
!                point.delta:(loc)
  SUBROUTINE Q_LSKUM_D()
    IMPLICIT NONE
    INTEGER :: i
    CALL COMPUTE_NORMALS_D()

    CALL GENERATE_CONNECTIVITY()
    
    if(rank == 0) then
            write(*,*)'%%%%-Normals and connectivity generated-%%%'
            write(*,*)
    end if
! Set U_old to U for first iteration
    DO i=1,local_points
      point%u_old(1, i) = point%prim(1, i)
      point%u_old(2, i) = point%prim(1, i)*point%prim(2, i)
      point%u_old(3, i) = point%prim(1, i)*point%prim(3, i)
      point%u_old(4, i) = 2.5d0*point%prim(4, i) + 0.5d0*point%prim(1, i&
&       )*(point%prim(2, i)*point%prim(2, i)+point%prim(3, i)*point%prim&
&       (3, i))
    END DO
    total_enstrophyd = 0.0_8
    cdd = 0.0_8
    cld = 0.0_8
    clcdd = 0.0_8
    cmd = 0.0_8
    total_entropyd = 0.0_8
    pointd%prim = 0.0_8
    pointd%prim_old = 0.0_8
    pointd%flux_res = 0.0_8
    pointd%q = 0.0_8
    pointd%dq = 0.0_8
    pointd%qm = 0.0_8
    pointd%vorticity_sqr = 0.0_8
    pointd%delta = 0.0_8
    if(restart == 0)itr = 0
    DO it=itr+1, itr+max_iters
      CALL FPI_SOLVER_D(it)
      if (rank==0) then
        write(*,'(a12,i8,a15,e30.20)')'iterations:',it,'residue:',residue
      end if
    END DO
  END SUBROUTINE Q_LSKUM_D

  SUBROUTINE Q_LSKUM()
    IMPLICIT NONE
    INTEGER :: i
    CALL COMPUTE_NORMALS()
    CALL GENERATE_CONNECTIVITY()
! Set U_old to U for first iteration
    DO i=1,local_points
      point%u_old(1, i) = point%prim(1, i)
      point%u_old(2, i) = point%prim(1, i)*point%prim(2, i)
      point%u_old(3, i) = point%prim(1, i)*point%prim(3, i)
      point%u_old(4, i) = 2.5d0*point%prim(4, i) + 0.5d0*point%prim(1, i&
&       )*(point%prim(2, i)*point%prim(2, i)+point%prim(3, i)*point%prim&
&       (3, i))
    END DO
    DO it=1,max_iters
      CALL FPI_SOLVER(it)
    END DO
  END SUBROUTINE Q_LSKUM

END MODULE Q_LSKUM_MOD_DIFF

