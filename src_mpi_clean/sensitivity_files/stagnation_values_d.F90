!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.14 (r7259) - 18 Jan 2019 09:36
!
MODULE STAGNATION_VALUES_MOD_DIFF
! #include <petsc/finclude/petscsys.h>
  USE DATA_STRUCTURE_MOD_DIFF
  USE PETSC_DATA_STRUCTURE_MOD
  IMPLICIT NONE

CONTAINS
  SUBROUTINE STAGNATION_PRESSURE()
    IMPLICIT NONE
    INTEGER :: i, indexmin, indexmax
    REAL*8 :: p0_inf, gammapower, pmin, pmax, p0, mach_t, angle
    REAL*8 :: prim(4)
    INTRINSIC SQRT
    REAL*8 :: pwx1
    REAL*8 :: pwr1
    REAL*8 :: arg1
    REAL*8 :: result1
    gammapower = gamma/(gamma-1)
    pwx1 = 1 + (gamma-1)/2*mach*mach
    pwr1 = pwx1**gammapower
    p0_inf = pr_inf*pwr1
    DO i=1,max_points
      prim = point%prim(:, i)
      arg1 = gamma*prim(4)/prim(1)
      angle = SQRT(arg1)
      arg1 = prim(2)**2 + prim(3)**2
      result1 = SQRT(arg1)
      mach_t = result1/angle
      pwx1 = 1 + (gamma-1)/2*mach_t*mach_t
      pwr1 = pwx1**gammapower
      p0 = prim(4)*pwr1
      IF (i .EQ. 1) THEN
        pmin = p0
        indexmin = i
        indexmax = i
        pmax = p0
      ELSE IF (p0 .LT. pmin) THEN
        pmin = p0
        indexmin = i
      ELSE IF (p0 .GT. pmax) THEN
        pmax = p0
        indexmax = i
      END IF
    END DO
    WRITE(*, *) 'Stagnation values are ', pmin, ' ', pmax, ' ', pmin/&
&   p0_inf, ' ', pmax/p0_inf, ' ', indexmin, ' ', indexmax
  END SUBROUTINE STAGNATION_PRESSURE

!  Differentiation of objective_function_j in forward (tangent) mode (with options fixinterface):
!   variations   of useful results: total_loss_stagpressure
!   with respect to varying inputs: *(point.prim)
!   Plus diff mem management of: point.prim:in
  SUBROUTINE OBJECTIVE_FUNCTION_J_D()
    IMPLICIT NONE
! if(rank == 0) then
! write(*,*) "J: ", total_loss_stagpressure
! endif
    INTEGER :: i
    REAL*8 :: p0_inf, gammapower, p0, p0_sum, constant, angle, mach_t
    REAL*8 :: p0d, p0_sumd, angled, mach_td
    REAL*8 :: prim(4)
    REAL*8 :: primd(4)
    REAL*8 :: total_p0
    REAL*8 :: total_p0d
    INTRINSIC SQRT
    REAL*8 :: pwx1
    REAL*8 :: pwx1d
    REAL*8 :: pwr1
    REAL*8 :: pwr1d
    REAL*8 :: arg1
    REAL*8 :: arg1d
    REAL*8 :: result1
    REAL*8 :: result1d
! PetscErrorCode :: ierr
    gammapower = gamma/(gamma-1)
    pwx1 = 1 + (gamma-1)/2*mach*mach
    pwr1 = pwx1**gammapower
    p0_inf = pr_inf*pwr1
    constant = 1/(p0_inf**2*plen)
    p0_sum = 0.0d0
    p0_sumd = 0.0_8
    DO i=1,local_points
      primd = pointd%prim(:, i)
      prim = point%prim(:, i)
      arg1d = (gamma*primd(4)*prim(1)-gamma*prim(4)*primd(1))/prim(1)**2
      arg1 = gamma*prim(4)/prim(1)
      IF (arg1 .EQ. 0.0) THEN
        angled = 0.0_8
      ELSE
        angled = arg1d/(2.0*SQRT(arg1))
      END IF
      angle = SQRT(arg1)
      arg1d = 2*prim(2)*primd(2) + 2*prim(3)*primd(3)
      arg1 = prim(2)**2 + prim(3)**2
      IF (arg1 .EQ. 0.0) THEN
        result1d = 0.0_8
      ELSE
        result1d = arg1d/(2.0*SQRT(arg1))
      END IF
      result1 = SQRT(arg1)
      mach_td = (result1d*angle-result1*angled)/angle**2
      mach_t = result1/angle
      pwx1d = (gamma-1)*(mach_td*mach_t+mach_t*mach_td)/2
      pwx1 = 1 + (gamma-1)/2*mach_t*mach_t
      IF (pwx1 .GT. 0.0 .OR. (pwx1 .LT. 0.0 .AND. gammapower .EQ. INT(&
&         gammapower))) THEN
        pwr1d = gammapower*pwx1**(gammapower-1)*pwx1d
      ELSE IF (pwx1 .EQ. 0.0 .AND. gammapower .EQ. 1.0) THEN
        pwr1d = pwx1d
      ELSE
        pwr1d = 0.0
      END IF
      pwr1 = pwx1**gammapower
      p0d = primd(4)*pwr1 + prim(4)*pwr1d
      p0 = prim(4)*pwr1
      p0_sumd = p0_sumd - 2*(p0_inf-p0)*p0d
      p0_sum = p0_sum + (p0_inf-p0)**2
    END DO
    total_p0d = p0_sumd
    total_p0 = p0_sum*1.0
! call MPI_Allreduce(p0_sum, total_p0, 1, MPI_DOUBLE, MPI_SUM, &
!    PETSC_COMM_WORLD, ierr)
    total_loss_stagpressured = constant*total_p0d
    total_loss_stagpressure = total_p0*constant
  END SUBROUTINE OBJECTIVE_FUNCTION_J_D

  SUBROUTINE OBJECTIVE_FUNCTION_J()
    IMPLICIT NONE
! if(rank == 0) then
! write(*,*) "J: ", total_loss_stagpressure
! endif
    INTEGER :: i
    REAL*8 :: p0_inf, gammapower, p0, p0_sum, constant, angle, mach_t
    REAL*8 :: prim(4)
    REAL*8 :: total_p0
    INTRINSIC SQRT
    REAL*8 :: pwx1
    REAL*8 :: pwr1
    REAL*8 :: arg1
    REAL*8 :: result1
! PetscErrorCode :: ierr
    gammapower = gamma/(gamma-1)
    pwx1 = 1 + (gamma-1)/2*mach*mach
    pwr1 = pwx1**gammapower
    p0_inf = pr_inf*pwr1
    constant = 1/(p0_inf**2*plen)
    p0_sum = 0.0d0
    DO i=1,local_points
      prim = point%prim(:, i)
      arg1 = gamma*prim(4)/prim(1)
      angle = SQRT(arg1)
      arg1 = prim(2)**2 + prim(3)**2
      result1 = SQRT(arg1)
      mach_t = result1/angle
      pwx1 = 1 + (gamma-1)/2*mach_t*mach_t
      pwr1 = pwx1**gammapower
      p0 = prim(4)*pwr1
      p0_sum = p0_sum + (p0_inf-p0)**2
    END DO
    total_p0 = p0_sum*1.0
! call MPI_Allreduce(p0_sum, total_p0, 1, MPI_DOUBLE, MPI_SUM, &
!    PETSC_COMM_WORLD, ierr)
    total_loss_stagpressure = total_p0*constant
  END SUBROUTINE OBJECTIVE_FUNCTION_J

END MODULE STAGNATION_VALUES_MOD_DIFF

