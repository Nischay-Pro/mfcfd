!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.16 (master) -  9 Oct 2020 17:47
!
MODULE LIMITERS_MOD_DIFF
  USE DATA_STRUCTURE_MOD_DIFF
  IMPLICIT NONE

CONTAINS
!	The following two subroutines are used for min-max limiter ..
  SUBROUTINE MAX_Q_VALUE(i, maxi)
    IMPLICIT NONE
    INTEGER :: i, j, k, r
    REAL*8 :: maxi(4)
    maxi = point%q(:, i)
    DO j=1,point%nbhs(i)
      k = point%conn(i, j)
      DO r=1,4
        IF (maxi(r) .LT. point%q(r, k)) maxi(r) = point%q(r, k)
      END DO
    END DO
  END SUBROUTINE MAX_Q_VALUE

  SUBROUTINE MIN_Q_VALUE(i, mini)
    IMPLICIT NONE
    INTEGER :: i, j, k, r
    REAL*8 :: mini(4)
    mini = point%q(:, i)
    DO j=1,point%nbhs(i)
      k = point%conn(i, j)
      DO r=1,4
        IF (mini(r) .GT. point%q(r, k)) mini(r) = point%q(r, k)
      END DO
    END DO
  END SUBROUTINE MIN_Q_VALUE

!  Differentiation of venkat_limiter in reverse (adjoint) mode (with options fixinterface):
!   gradient     of useful results: *(point.q) *(point.qm) phi
!   with respect to varying inputs: *(point.q) *(point.qm) qtilde
!                phi
!   Plus diff mem management of: point.q:in point.qm:in
!	The following subroutines are used for venkatakrishnan limiter .. 	
  SUBROUTINE VENKAT_LIMITER_B(qtilde, qtildeb, phi, phib, k)
    IMPLICIT NONE
    INTEGER :: r, k
    REAL*8 :: qtilde(4), phi(4)
    REAL*8 :: qtildeb(4), phib(4)
    REAL*8 :: q, del_neg, del_pos
    REAL*8 :: qb, del_negb, del_posb
    REAL*8 :: max_q, min_q, ds, epsi, num, den, temp
    REAL*8 :: numb, denb, tempb
    INTRINSIC DABS
    DOUBLE PRECISION :: dabs0
    DOUBLE PRECISION :: dabs1
    INTEGER :: branch
    DO r=1,4
      q = point%q(r, k)
      del_neg = qtilde(r) - q
      IF (del_neg .GE. 0.) THEN
        dabs0 = del_neg
      ELSE
        dabs0 = -del_neg
      END IF
      IF (dabs0 .LE. 10e-6) THEN
        CALL PUSHCONTROL2B(3)
      ELSE
        IF (del_neg .GE. 0.) THEN
          dabs1 = del_neg
        ELSE
          dabs1 = -del_neg
        END IF
        IF (dabs1 .GT. 10e-6) THEN
          IF (del_neg .GT. 0.d0) THEN
            CALL PUSHREAL8(del_pos)
            del_pos = point%qm(1, r, k) - q
            CALL PUSHCONTROL2B(0)
          ELSE IF (del_neg .LT. 0.d0) THEN
            CALL PUSHREAL8(del_pos)
            del_pos = point%qm(2, r, k) - q
            CALL PUSHCONTROL2B(1)
          ELSE
            CALL PUSHCONTROL2B(2)
          END IF
          epsi = vl_const*point%min_dist(k)
          epsi = epsi**3.0d0
! Numerator .. 
          CALL PUSHREAL8(num)
          num = del_pos*del_pos + epsi*epsi
          CALL PUSHREAL8(num)
          num = num*del_neg + 2.0d0*del_neg*del_neg*del_pos
! Denominator ..
          CALL PUSHREAL8(den)
          den = del_pos*del_pos + 2.0d0*del_neg*del_neg
          den = den + del_neg*del_pos + epsi*epsi
          CALL PUSHREAL8(den)
          den = den*del_neg
          temp = num/den
          IF (temp .LT. 1.d0) THEN
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(0)
        END IF
      END IF
    END DO
    qtildeb = 0.0_8
    del_posb = 0.0_8
    DO r=4,1,-1
      CALL POPCONTROL2B(branch)
      IF (branch .LT. 2) THEN
        IF (branch .EQ. 0) THEN
          qb = 0.0_8
          del_negb = 0.0_8
          GOTO 100
        ELSE
          phib(r) = 0.0_8
          tempb = 0.0_8
        END IF
      ELSE IF (branch .EQ. 2) THEN
        tempb = phib(r)
        phib(r) = 0.0_8
      ELSE
        phib(r) = 0.0_8
        qb = 0.0_8
        del_negb = 0.0_8
        GOTO 100
      END IF
      numb = tempb/den
      denb = -(num*tempb/den**2)
      q = point%q(r, k)
      del_neg = qtilde(r) - q
      CALL POPREAL8(den)
      del_negb = den*denb
      denb = del_neg*denb
      del_posb = del_posb + (del_neg+2*del_pos)*denb + del_neg**2*2.0d0*&
&       numb
      CALL POPREAL8(den)
      CALL POPREAL8(num)
      del_negb = del_negb + (del_pos+2*del_neg*2.0d0)*denb + (num+2*&
&       del_neg*del_pos*2.0d0)*numb
      numb = del_neg*numb
      CALL POPREAL8(num)
      del_posb = del_posb + 2*del_pos*numb
      CALL POPCONTROL2B(branch)
      IF (branch .EQ. 0) THEN
        CALL POPREAL8(del_pos)
        pointb%qm(1, r, k) = pointb%qm(1, r, k) + del_posb
        qb = -del_posb
        del_posb = 0.0_8
      ELSE IF (branch .EQ. 1) THEN
        CALL POPREAL8(del_pos)
        pointb%qm(2, r, k) = pointb%qm(2, r, k) + del_posb
        qb = -del_posb
        del_posb = 0.0_8
      ELSE
        qb = 0.0_8
      END IF
 100  qtildeb(r) = qtildeb(r) + del_negb
      qb = qb - del_negb
      pointb%q(r, k) = pointb%q(r, k) + qb
    END DO
  END SUBROUTINE VENKAT_LIMITER_B

!	The following subroutines are used for venkatakrishnan limiter .. 	
  SUBROUTINE VENKAT_LIMITER(qtilde, phi, k)
    IMPLICIT NONE
    INTEGER :: r, k
    REAL*8 :: qtilde(4), phi(4)
    REAL*8 :: q, del_neg, del_pos
    REAL*8 :: max_q, min_q, ds, epsi, num, den, temp
    INTRINSIC DABS
    DOUBLE PRECISION :: dabs0
    DOUBLE PRECISION :: dabs1
    DO r=1,4
      q = point%q(r, k)
      del_neg = qtilde(r) - q
      IF (del_neg .GE. 0.) THEN
        dabs0 = del_neg
      ELSE
        dabs0 = -del_neg
      END IF
      IF (dabs0 .LE. 10e-6) THEN
        phi(r) = 1.d0
      ELSE
        IF (del_neg .GE. 0.) THEN
          dabs1 = del_neg
        ELSE
          dabs1 = -del_neg
        END IF
        IF (dabs1 .GT. 10e-6) THEN
          IF (del_neg .GT. 0.d0) THEN
            del_pos = point%qm(1, r, k) - q
          ELSE IF (del_neg .LT. 0.d0) THEN
            del_pos = point%qm(2, r, k) - q
          END IF
          epsi = vl_const*point%min_dist(k)
          epsi = epsi**3.0d0
! Numerator .. 
          num = del_pos*del_pos + epsi*epsi
          num = num*del_neg + 2.0d0*del_neg*del_neg*del_pos
! Denominator ..
          den = del_pos*del_pos + 2.0d0*del_neg*del_neg
          den = den + del_neg*del_pos + epsi*epsi
          den = den*del_neg
          temp = num/den
          IF (temp .LT. 1.d0) THEN
            phi(r) = temp
          ELSE
            phi(r) = 1.d0
          END IF
        END IF
      END IF
    END DO
  END SUBROUTINE VENKAT_LIMITER

END MODULE LIMITERS_MOD_DIFF

