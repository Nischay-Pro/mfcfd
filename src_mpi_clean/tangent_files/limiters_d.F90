!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.16 (master) -  9 Oct 2020 17:47
!
MODULE LIMITERS_MOD_DIFF
  USE DATA_STRUCTURE_MOD_DIFF
  IMPLICIT NONE

CONTAINS
!	The following two subroutines are used for min-max limiter ..
  SUBROUTINE MAX_Q_VALUE(i, maxi)
    IMPLICIT NONE
    INTEGER :: i, j, k, r
    REAL*8 :: maxi(4)
    maxi = point%q(:, i)
    DO j=1,point%nbhs(i)
      k = point%conn(i, j)
      DO r=1,4
        IF (maxi(r) .LT. point%q(r, k)) maxi(r) = point%q(r, k)
      END DO
    END DO
  END SUBROUTINE MAX_Q_VALUE

  SUBROUTINE MIN_Q_VALUE(i, mini)
    IMPLICIT NONE
    INTEGER :: i, j, k, r
    REAL*8 :: mini(4)
    mini = point%q(:, i)
    DO j=1,point%nbhs(i)
      k = point%conn(i, j)
      DO r=1,4
        IF (mini(r) .GT. point%q(r, k)) mini(r) = point%q(r, k)
      END DO
    END DO
  END SUBROUTINE MIN_Q_VALUE

!  Differentiation of venkat_limiter in forward (tangent) mode (with options fixinterface):
!   variations   of useful results: phi
!   with respect to varying inputs: *(point.q) *(point.qm) qtilde
!                phi
!   Plus diff mem management of: point.q:in point.qm:in
!	The following subroutines are used for venkatakrishnan limiter .. 	
  SUBROUTINE VENKAT_LIMITER_D(qtilde, qtilded, phi, phid, k)
    IMPLICIT NONE
    INTEGER :: r, k
    REAL*8 :: qtilde(4), phi(4)
    REAL*8 :: qtilded(4), phid(4)
    REAL*8 :: q, del_neg, del_pos
    REAL*8 :: qd, del_negd, del_posd
    REAL*8 :: max_q, min_q, ds, epsi, num, den, temp
    REAL*8 :: numd, dend, tempd
    INTRINSIC DABS
    DOUBLE PRECISION :: dabs0
    DOUBLE PRECISION :: dabs1
    del_posd = 0.0_8
    DO r=1,4
      qd = pointd%q(r, k)
      q = point%q(r, k)
      del_negd = qtilded(r) - qd
      del_neg = qtilde(r) - q
      IF (del_neg .GE. 0.) THEN
        dabs0 = del_neg
      ELSE
        dabs0 = -del_neg
      END IF
      IF (dabs0 .LE. 10e-6) THEN
        phid(r) = 0.0_8
        phi(r) = 1.d0
      ELSE
        IF (del_neg .GE. 0.) THEN
          dabs1 = del_neg
        ELSE
          dabs1 = -del_neg
        END IF
        IF (dabs1 .GT. 10e-6) THEN
          IF (del_neg .GT. 0.d0) THEN
            del_posd = pointd%qm(1, r, k) - qd
            del_pos = point%qm(1, r, k) - q
          ELSE IF (del_neg .LT. 0.d0) THEN
            del_posd = pointd%qm(2, r, k) - qd
            del_pos = point%qm(2, r, k) - q
          END IF
          epsi = vl_const*point%min_dist(k)
          epsi = epsi**3.0d0
! Numerator .. 
          numd = 2*del_pos*del_posd
          num = del_pos*del_pos + epsi*epsi
          numd = del_neg*numd + num*del_negd + 2.0d0*(del_pos*2*del_neg*&
&           del_negd+del_neg**2*del_posd)
          num = num*del_neg + 2.0d0*del_neg*del_neg*del_pos
! Denominator ..
          dend = 2*del_pos*del_posd + 2.0d0*2*del_neg*del_negd
          den = del_pos*del_pos + 2.0d0*del_neg*del_neg
          dend = dend + del_pos*del_negd + del_neg*del_posd
          den = den + del_neg*del_pos + epsi*epsi
          dend = del_neg*dend + den*del_negd
          den = den*del_neg
          tempd = (numd-num*dend/den)/den
          temp = num/den
          IF (temp .LT. 1.d0) THEN
            phid(r) = tempd
            phi(r) = temp
          ELSE
            phid(r) = 0.0_8
            phi(r) = 1.d0
          END IF
        END IF
      END IF
    END DO
  END SUBROUTINE VENKAT_LIMITER_D

!	The following subroutines are used for venkatakrishnan limiter .. 	
  SUBROUTINE VENKAT_LIMITER(qtilde, phi, k)
    IMPLICIT NONE
    INTEGER :: r, k
    REAL*8 :: qtilde(4), phi(4)
    REAL*8 :: q, del_neg, del_pos
    REAL*8 :: max_q, min_q, ds, epsi, num, den, temp
    INTRINSIC DABS
    DOUBLE PRECISION :: dabs0
    DOUBLE PRECISION :: dabs1
    DO r=1,4
      q = point%q(r, k)
      del_neg = qtilde(r) - q
      IF (del_neg .GE. 0.) THEN
        dabs0 = del_neg
      ELSE
        dabs0 = -del_neg
      END IF
      IF (dabs0 .LE. 10e-6) THEN
        phi(r) = 1.d0
      ELSE
        IF (del_neg .GE. 0.) THEN
          dabs1 = del_neg
        ELSE
          dabs1 = -del_neg
        END IF
        IF (dabs1 .GT. 10e-6) THEN
          IF (del_neg .GT. 0.d0) THEN
            del_pos = point%qm(1, r, k) - q
          ELSE IF (del_neg .LT. 0.d0) THEN
            del_pos = point%qm(2, r, k) - q
          END IF
          epsi = vl_const*point%min_dist(k)
          epsi = epsi**3.0d0
! Numerator .. 
          num = del_pos*del_pos + epsi*epsi
          num = num*del_neg + 2.0d0*del_neg*del_neg*del_pos
! Denominator ..
          den = del_pos*del_pos + 2.0d0*del_neg*del_neg
          den = den + del_neg*del_pos + epsi*epsi
          den = den*del_neg
          temp = num/den
          IF (temp .LT. 1.d0) THEN
            phi(r) = temp
          ELSE
            phi(r) = 1.d0
          END IF
        END IF
      END IF
    END DO
  END SUBROUTINE VENKAT_LIMITER

END MODULE LIMITERS_MOD_DIFF

