!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.16 (master) -  9 Oct 2020 17:47
!
MODULE COMPUTE_ENTROPY_MOD_DIFF
! #include <petsc/finclude/petscsys.h>
  USE DATA_STRUCTURE_MOD_DIFF
  IMPLICIT NONE

CONTAINS
! use petsc_data_structure_mod
  SUBROUTINE COMPUTE_ENTROPY()
    IMPLICIT NONE
    INTEGER :: k
    REAL*8 :: temp1, temp2
    REAL*8 :: gtotal_entropy
    INTRINSIC DLOG
    INTEGER :: petsc_comm_world
    INTEGER :: ierr
    INTEGER :: mpi_sum
    INTEGER :: mpi_double
    INTEGER :: rank
! PetscErrorCode :: ierr
    total_entropy = 0.d0
    temp2 = DLOG(pr_inf)
    DO k=1,local_points
      temp1 = point%prim(1, k)**gamma
      temp1 = point%prim(4, k)/temp1
      temp1 = DLOG(temp1)
      point%entropy(k) = (temp1-temp2)**2
      total_entropy = total_entropy + (temp1-temp2)**2
    END DO
    CALL MPI_REDUCE(total_entropy, gtotal_entropy, 1, mpi_double, mpi_sum, 0, petsc_comm_world, ierr)
    IF (rank .EQ. 0) WRITE(*, *) 'total entropy :', gtotal_entropy
  END SUBROUTINE COMPUTE_ENTROPY

!  Differentiation of compute_enstrophy in forward (tangent) mode (with options fixinterface):
!   variations   of useful results: total_enstrophy
!   with respect to varying inputs: *(point.prim)
!   Plus diff mem management of: point.prim:in
  SUBROUTINE COMPUTE_ENSTROPHY_D()
    IMPLICIT NONE
    INTEGER :: i, k, r, nbh
    REAL*8 :: x_i, y_i, x_k, y_k
    REAL*8 :: delx, dely, dist, weights
    REAL*8 :: sum_delx_sqr, sum_dely_sqr, sum_delx_dely
    REAL*8 :: sum_delx_delu1, sum_delx_delu2, sum_dely_delu1, sum_dely_delu2
    REAL*8 :: sum_delx_delu1d, sum_delx_delu2d, sum_dely_delu1d, sum_dely_delu2d
    REAL*8 :: sum_delx_sqr_delu1_sqr, sum_delx_sqr_delu2_sqr, sum_dely_sqr_delu1_sqr, sum_dely_sqr_delu2_sqr
    REAL*8 :: det
    REAL*8 :: one_by_det
    REAL*8 :: du1_dy, du2_dx, temp, du1_sqr_dx_sqr, du2_sqr_dy_sqr, du1_dx, du2_dy
    REAL*8 :: du1_dyd, du2_dxd, du1_dxd, du2_dyd
    REAL*8 :: gtotal_enstrophy
    INTRINSIC DSQRT
    REAL*8 :: arg1
    INTEGER :: rank
! PetscErrorCode :: ierr
    total_enstrophy = 0.d0
    total_enstrophyd = 0.0_8
    DO i=1,local_points
      x_i = point%x(i)
      y_i = point%y(i)
      sum_delx_sqr = 0.d0
      sum_dely_sqr = 0.d0
      sum_delx_dely = 0.d0
      sum_delx_delu1 = 0.d0
      sum_dely_delu1 = 0.d0
      sum_delx_delu2 = 0.d0
      sum_dely_delu2 = 0.d0
      sum_dely_delu1d = 0.0_8
      sum_dely_delu2d = 0.0_8
      sum_delx_delu1d = 0.0_8
      sum_delx_delu2d = 0.0_8
      DO k=1,point%nbhs(i)
        nbh = point%conn(i, k)
        x_k = point%x(nbh)
        y_k = point%y(nbh)
        delx = x_k - x_i
        dely = y_k - y_i
        arg1 = delx*delx + dely*dely
        dist = DSQRT(arg1)
        weights = dist**power
        sum_delx_sqr = sum_delx_sqr + delx*delx*weights
        sum_dely_sqr = sum_dely_sqr + dely*dely*weights
        sum_delx_dely = sum_delx_dely + delx*dely*weights
        sum_delx_delu1d = sum_delx_delu1d + weights*delx*(pointd%prim(2, nbh)-pointd%prim(2, i))
        sum_delx_delu1 = sum_delx_delu1 + weights*delx*(point%prim(2, nbh)-point%prim(2, i))
        sum_delx_delu2d = sum_delx_delu2d + weights*delx*(pointd%prim(3, nbh)-pointd%prim(3, i))
        sum_delx_delu2 = sum_delx_delu2 + weights*delx*(point%prim(3, nbh)-point%prim(3, i))
        sum_dely_delu1d = sum_dely_delu1d + weights*dely*(pointd%prim(2, nbh)-pointd%prim(2, i))
        sum_dely_delu1 = sum_dely_delu1 + weights*dely*(point%prim(2, nbh)-point%prim(2, i))
        sum_dely_delu2d = sum_dely_delu2d + weights*dely*(pointd%prim(3, nbh)-pointd%prim(3, i))
        sum_dely_delu2 = sum_dely_delu2 + weights*dely*(point%prim(3, nbh)-point%prim(3, i))
      END DO
      det = sum_delx_sqr*sum_dely_sqr - sum_delx_dely*sum_delx_dely
      one_by_det = 1.0d0/det
      du2_dxd = one_by_det*(sum_dely_sqr*sum_delx_delu2d-sum_delx_dely*sum_dely_delu2d)
      du2_dx = (sum_delx_delu2*sum_dely_sqr-sum_dely_delu2*sum_delx_dely)*one_by_det
      du1_dyd = one_by_det*(sum_delx_sqr*sum_dely_delu1d-sum_delx_dely*sum_delx_delu1d)
      du1_dy = (sum_dely_delu1*sum_delx_sqr-sum_delx_delu1*sum_delx_dely)*one_by_det
      du2_dyd = one_by_det*(sum_delx_sqr*sum_dely_delu2d-sum_delx_dely*sum_delx_delu2d)
      du2_dy = (sum_dely_delu2*sum_delx_sqr-sum_delx_delu2*sum_delx_dely)*one_by_det
      du1_dxd = one_by_det*(sum_dely_sqr*sum_delx_delu1d-sum_delx_dely*sum_dely_delu1d)
      du1_dx = (sum_delx_delu1*sum_dely_sqr-sum_dely_delu1*sum_delx_dely)*one_by_det
      total_enstrophyd = total_enstrophyd + point%vor_area(i)*(2*du1_dx*du1_dxd+2*du2_dx*du2_dxd+2*du1_dy*du1_dyd+2*du2_dy*du2_dyd)
      total_enstrophy = total_enstrophy + (du1_dx*du1_dx+du2_dx*du2_dx+du1_dy*du1_dy+du2_dy*du2_dy)*point%vor_area(i)
    END DO
! call MPI_Reduce(total_enstrophy, gtotal_enstrophy , 1, &
! & MPI_DOUBLE, MPI_SUM, 0, PETSC_COMM_WORLD, ierr)
    IF (rank .EQ. 0) WRITE(*, *) 'total enstrophy :', gtotal_enstrophy
  END SUBROUTINE COMPUTE_ENSTROPHY_D

  SUBROUTINE COMPUTE_ENSTROPHY()
    IMPLICIT NONE
    INTEGER :: i, k, r, nbh
    REAL*8 :: x_i, y_i, x_k, y_k
    REAL*8 :: delx, dely, dist, weights
    REAL*8 :: sum_delx_sqr, sum_dely_sqr, sum_delx_dely
    REAL*8 :: sum_delx_delu1, sum_delx_delu2, sum_dely_delu1, sum_dely_delu2
    REAL*8 :: sum_delx_sqr_delu1_sqr, sum_delx_sqr_delu2_sqr, sum_dely_sqr_delu1_sqr, sum_dely_sqr_delu2_sqr
    REAL*8 :: det
    REAL*8 :: one_by_det
    REAL*8 :: du1_dy, du2_dx, temp, du1_sqr_dx_sqr, du2_sqr_dy_sqr, du1_dx, du2_dy
    REAL*8 :: gtotal_enstrophy
    INTRINSIC DSQRT
    REAL*8 :: arg1
    INTEGER :: rank
! PetscErrorCode :: ierr
    total_enstrophy = 0.d0
    DO i=1,local_points
      x_i = point%x(i)
      y_i = point%y(i)
      sum_delx_sqr = 0.d0
      sum_dely_sqr = 0.d0
      sum_delx_dely = 0.d0
      sum_delx_delu1 = 0.d0
      sum_dely_delu1 = 0.d0
      sum_delx_delu2 = 0.d0
      sum_dely_delu2 = 0.d0
      DO k=1,point%nbhs(i)
        nbh = point%conn(i, k)
        x_k = point%x(nbh)
        y_k = point%y(nbh)
        delx = x_k - x_i
        dely = y_k - y_i
        arg1 = delx*delx + dely*dely
        dist = DSQRT(arg1)
        weights = dist**power
        sum_delx_sqr = sum_delx_sqr + delx*delx*weights
        sum_dely_sqr = sum_dely_sqr + dely*dely*weights
        sum_delx_dely = sum_delx_dely + delx*dely*weights
        sum_delx_delu1 = sum_delx_delu1 + weights*delx*(point%prim(2, nbh)-point%prim(2, i))
        sum_delx_delu2 = sum_delx_delu2 + weights*delx*(point%prim(3, nbh)-point%prim(3, i))
        sum_dely_delu1 = sum_dely_delu1 + weights*dely*(point%prim(2, nbh)-point%prim(2, i))
        sum_dely_delu2 = sum_dely_delu2 + weights*dely*(point%prim(3, nbh)-point%prim(3, i))
      END DO
      det = sum_delx_sqr*sum_dely_sqr - sum_delx_dely*sum_delx_dely
      one_by_det = 1.0d0/det
      du2_dx = (sum_delx_delu2*sum_dely_sqr-sum_dely_delu2*sum_delx_dely)*one_by_det
      du1_dy = (sum_dely_delu1*sum_delx_sqr-sum_delx_delu1*sum_delx_dely)*one_by_det
      du2_dy = (sum_dely_delu2*sum_delx_sqr-sum_delx_delu2*sum_delx_dely)*one_by_det
      du1_dx = (sum_delx_delu1*sum_dely_sqr-sum_dely_delu1*sum_delx_dely)*one_by_det
      total_enstrophy = total_enstrophy + (du1_dx*du1_dx+du2_dx*du2_dx+du1_dy*du1_dy+du2_dy*du2_dy)*point%vor_area(i)
    END DO
! call MPI_Reduce(total_enstrophy, gtotal_enstrophy , 1, &
! & MPI_DOUBLE, MPI_SUM, 0, PETSC_COMM_WORLD, ierr)
    IF (rank .EQ. 0) WRITE(*, *) 'total enstrophy :', gtotal_enstrophy
  END SUBROUTINE COMPUTE_ENSTROPHY

END MODULE COMPUTE_ENTROPY_MOD_DIFF

